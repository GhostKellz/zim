# ZIM CLI Reference

Complete command-line reference for ZIM - Zig Infrastructure Manager.

## Table of Contents

- [Global Options](#global-options)
- [Toolchain Commands](#toolchain-commands)
- [Dependency Commands](#dependency-commands)
- [Target Commands](#target-commands)
- [Cache Commands](#cache-commands)
- [Policy Commands](#policy-commands)
- [Utility Commands](#utility-commands)

---

## Global Options

Available with all commands:

```bash
--json              Output in JSON format
--verbose, -v       Enable verbose output
--quiet, -q         Minimal output (errors only)
--cache-dir <dir>   Override default cache directory
--config <file>     Use specific config file
--help, -h          Show help message
--version           Show version information
```

**Examples:**
```bash
zim --json deps graph              # JSON output
zim --verbose install 0.16.0       # Verbose installation
zim --cache-dir /tmp/zim deps fetch  # Custom cache location
```

---

## Toolchain Commands

Manage Zig compiler versions (like rustup for Rust).

### `zim toolchain list`

List all installed Zig toolchains.

```bash
zim toolchain list
```

**Output:**
```
Installed Zig toolchains:

  0.16.0 (active)
  0.13.0
  0.12.1

Local custom toolchains:
  (none)
```

### `zim toolchain install <version>`

Install a specific Zig version.

```bash
zim toolchain install 0.16.0
zim toolchain install 0.13.0
```

**Shorthand:**
```bash
zim install 0.16.0
```

**What it does:**
1. Downloads from ziglang.org
2. Verifies hash with zcrypto
3. Extracts to `~/.zim/toolchains/<version>`
4. Makes available for use

### `zim toolchain use <version>`

Set global active Zig version.

```bash
zim toolchain use 0.16.0
```

**Shorthand:**
```bash
zim use 0.16.0
```

**Creates:**
- Symlink at `~/.zim/toolchains/active` â†’ `0.16.0`
- Or on Windows: writes to `active.txt`

### `zim toolchain pin <version>`

Pin project to specific Zig version.

```bash
zim toolchain pin 0.16.0
```

**Creates:** `.zim/toolchain.toml` in current directory:
```toml
# ZIM toolchain configuration
# Generated by: zim toolchain pin 0.16.0

zig = "0.16.0"

# Uncomment to add cross-compilation targets
# targets = ["x86_64-linux-gnu", "aarch64-linux-gnu", "wasm32-wasi"]
```

---

## Dependency Commands

Manage project dependencies (like cargo for Rust, npm for Node.js).

### `zim deps init [name]`

Initialize new project with dependency manifest.

```bash
zim deps init my-project
```

**Creates:** `zim.toml`:
```toml
# ZIM project manifest

[project]
name = "my-project"
version = "0.1.0"
zig = "0.16.0"

[dependencies]
# Add dependencies here
# example = { git = "https://github.com/user/repo", ref = "main" }
# other = { tarball = "https://example.com/package.tar.gz", hash = "sha256:..." }

[dev-dependencies]
# Development dependencies

[targets]
# Cross-compilation targets
default = ["native"]
```

### `zim deps add <spec>`

Add a dependency to the project.

```bash
# GitHub shorthand (recommended)
zim deps add zpack gh/hendriknielaender/zpack@v0.3.3
zim deps add zsync gh/ghostkellz/zsync@main

# Git dependency
zim deps add zsync --git https://github.com/user/zsync --ref main

# Tarball dependency
zim deps add package --tarball https://example.com/pkg.tar.gz --hash sha256:abc123

# Local dependency
zim deps add mylib --local /path/to/mylib

# Registry dependency (future)
zim deps add zhttp@0.1.4
```

**GitHub Shorthand Syntax:**
```
gh/owner/repo[@ref]
```

- `@ref` is optional and can be:
  - Tag: `@v1.0.0`
  - Branch: `@main`, `@develop`
  - Commit: `@abc1234`

If omitted, uses the repository's default branch.

**See:** [GitHub Integration Guide](GITHUB_INTEGRATION.md)

### `zim deps fetch`

Fetch and cache all dependencies.

```bash
zim deps fetch
```

**What it does:**
1. Reads `zim.toml` manifest
2. Resolves dependency graph
3. Downloads to content-addressed cache
4. Verifies hashes with zcrypto
5. Creates/updates `zim.lock` lockfile

**Cache structure:**
```
~/.cache/zim/deps/
â”œâ”€â”€ ab/
â”‚   â””â”€â”€ cd/
â”‚       â””â”€â”€ abcdef1234567890...
â””â”€â”€ 12/
    â””â”€â”€ 34/
        â””â”€â”€ 1234567890abcdef...
```

### `zim deps graph`

Display dependency tree with cycle detection.

```bash
zim deps graph
```

**Output:**
```
ğŸ“¦ Dependency Graph
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

my-project @ 1.0.0
â”œâ”€ zpack @ 0.3.3
â”‚  â”œâ”€ miniz @ 3.0.2
â”‚  â””â”€ zlib @ 1.2.13
â”œâ”€ zsync @ 1.0.0
â”‚  â”œâ”€ zpack @ 0.3.3 â†» (already shown)
â”‚  â””â”€ flash @ 0.1.0
â””â”€ zhttp @ 0.2.0
   â””â”€ zsync @ 1.0.0 â†» (already shown)

Total: 3 direct, 6 total dependencies
```

**Features:**
- ASCII tree visualization
- Cycle detection with `â†»` indicator
- Transitive dependency tracking
- Duplicate dependency highlighting

**Export options:**
```bash
# Export to DOT format for Graphviz
zim deps graph --format dot > deps.dot
dot -Tpng deps.dot -o deps.png
```

### `zim deps update [package]`

Update dependencies to latest versions.

```bash
zim deps update           # Update all
zim deps update zsync     # Update specific package
```

---

## Target Commands

Manage cross-compilation targets.

### `zim target add <triple>`

Add a cross-compilation target.

```bash
zim target add x86_64-linux-gnu
zim target add aarch64-linux-gnu
zim target add wasm32-wasi
```

**Output:**
```
Adding target: wasm32-wasi
âœ“ Target wasm32-wasi added successfully
  Architecture: wasm32
  OS: wasi

âœ“ Standard library is available (bundled with Zig toolchain)
  For custom sysroot/libc headers, place them in: /home/user/.zim/targets/wasm32-wasi
```

### `zim target list`

List installed targets.

```bash
zim target list
```

**Output:**
```
Installed cross-compilation targets:

  wasm32-wasi
  aarch64-linux-gnu

Common targets:
  x86_64-linux-gnu       - Linux x86_64
  aarch64-linux-gnu      - Linux ARM64
  x86_64-windows-gnu     - Windows x86_64
  x86_64-macos           - macOS x86_64
  aarch64-macos          - macOS ARM64 (Apple Silicon)
  wasm32-wasi            - WebAssembly WASI
  wasm32-freestanding    - WebAssembly bare
```

### `zim target remove <triple>`

Remove a target.

```bash
zim target remove wasm32-wasi
```

---

## Cache Commands

Manage dependency cache.

### `zim cache status`

Show cache statistics.

```bash
zim cache status
```

**Output:**
```
Cache status:
  Location: /home/user/.cache/zim
  (Detailed statistics not yet implemented)
```

### `zim cache prune [--dry-run]`

Remove unused cache entries.

```bash
zim cache prune            # Actually prune
zim cache prune --dry-run  # Preview what would be deleted
```

### `zim cache integrity`

Verify cache integrity.

```bash
zim cache integrity
```

**Output:**
```
ğŸ” Cache Integrity Check
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Scanning cache directory...

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total files: 42
  Total size: 125847291 bytes

âœ… Cache integrity OK
```

**If corruption detected:**
```
ğŸ” Cache Integrity Check
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Scanning cache directory...

  âœ— Corrupted: ab/cd/abcdef123456...
  âœ— Corrupted: 12/34/123456789abc...

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total files: 42
  Total size: 125847291 bytes
  Corrupted files: 2

âš  Run 'zim cache clean' to remove corrupted files
```

**See:** [Diagnostics Guide](DIAGNOSTICS.md)

---

## Policy Commands

Security and policy enforcement.

### `zim policy audit`

Audit dependencies against security policy.

```bash
zim policy audit
```

**Requires:** `.zim/policy.json` configuration file:

```json
{
  "allow": [
    "github.com/*",
    "ziglang.org/*"
  ],
  "deny": [
    "malicious/*",
    "untrusted/*"
  ],
  "require_hash": true
}
```

**Output (all pass):**
```
ğŸ“‹ Policy Audit Report
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ“ All 8 dependencies passed policy checks
```

**Output (violations):**
```
ğŸ“‹ Policy Audit Report
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âš  2/8 dependencies failed policy checks

Violations:
  âœ— suspicious-package
    Package 'suspicious-package' matches deny pattern: untrusted/*

  âœ— no-hash-package
    Package 'no-hash-package' requires hash verification but none provided
```

**Policy Enforcement Modes:**
```toml
# .zim/config.toml
[policy]
mode = "strict"  # "strict", "warn", or "off"
```

- **strict**: Fail builds on policy violations
- **warn**: Show warnings but allow builds
- **off**: Disable policy checks

**See:** [Diagnostics Guide](DIAGNOSTICS.md#policy-audits)

### `zim verify`

Verify project integrity (checksums, signatures).

```bash
zim verify
```

**Output:**
```
Verifying project integrity...

Verifying dependencies...
  Verifying zsync... âœ“
  Verifying zhttp... âœ“

âœ“ Verified 2 dependencies

âœ“ All integrity checks passed
```

---

## Utility Commands

### `zim doctor`

Run comprehensive system diagnostics.

```bash
zim doctor
```

**Output:**
```
ğŸ” ZIM System Diagnostics
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  âœ“ Zig Installation: Zig 0.16.0-dev.1225+bf9082518 installed
  âœ“ Cache Directory: Cache directory exists: /home/user/.cache/zim
  âœ“ Global Config: Global config loaded successfully
  âœ“ Network Connectivity: Network connectivity is working
  âœ“ Disk Space: Disk space available

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… All checks passed (5 ok)
```

**Checks Performed:**
- **Zig Installation**: Verifies `zig` is in PATH and reports version
- **Cache Directory**: Validates cache exists and has write permissions
- **Global Configuration**: Loads and validates `~/.config/zim/config.toml`
- **Network Connectivity**: Tests connection to github.com
- **Disk Space**: Checks available space and warns if low

### `zim doctor workspace`

Check workspace health and detect manifest/lockfile drift.

```bash
zim doctor workspace
```

**Output (when in sync):**
```
ğŸ” Workspace Diagnostics
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ“ Found zim.toml
âœ“ Found zim.lock

âœ… Manifest and lockfile are in sync
âœ“ build.zig.zon is up to date
```

**Output (drift detected):**
```
ğŸ” Workspace Diagnostics
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ“ Found zim.toml
âœ“ Found zim.lock

âš  Manifest is newer than lockfile
  zim.toml has been modified since last fetch
  Run 'zim deps fetch' to update lockfile

âš  Lockfile is newer than build.zig.zon
  Run 'zim deps export' to update build.zig.zon
```

**Checks:**
- Manifest existence (`zim.toml`)
- Lockfile existence (`zim.lock`)
- Timestamp comparison
- `build.zig.zon` synchronization

**See:** [Diagnostics Guide](DIAGNOSTICS.md)

### `zim version`

Show version information.

```bash
zim version
```

**Output:**
```
zim 0.1.0-dev
Zig Infrastructure Manager
Zig version: 0.16.0-dev.1225+bf9082518
```

### `zim update`

Update ZIM to the latest version.

```bash
zim update
```

**What it does:**
1. Checks GitHub for latest ZIM release
2. Compares with current version
3. Downloads platform-specific binary
4. Creates backup of current installation
5. Replaces binary with new version
6. Verifies update succeeded

**Output:**
```
ğŸ” Checking for updates...

Current version: 0.3.3
Latest version:  0.3.4

Update available!

Download latest version? [y/N]: y

ğŸ“¥ Downloading update...
  [=================] 100% (5.2 MB)

âœ… Update successful!
  ZIM updated: 0.3.3 â†’ 0.3.4

Restart your shell to ensure the new version is active.
```

**Rollback on failure:**
If the update fails, ZIM automatically restores the backup.

**Skip prompt:**
```bash
zim update --yes  # Auto-accept update
```

### `zim help`

Show help message.

```bash
zim help
zim <command> --help
```

---

## Configuration Files

### Project Configuration: `.zim/toolchain.toml`

```toml
# ZIM toolchain configuration
zig = "0.16.0"

# Cross-compilation targets
targets = ["x86_64-linux-gnu", "wasm32-wasi"]
```

### Global Configuration: `~/.config/zim/config.toml`

```toml
[cache]
dir = "/custom/cache/dir"
max_size = 10737418240  # 10GB

[registry]
url = "https://zim.example.com/registry"
mirror = "https://mirror.example.com"

[policy]
require_signatures = true
allowed_sources = ["github.com", "gitlab.com"]
denied_sources = []

[network]
ca_bundle = "/etc/ssl/certs/ca-bundle.crt"
```

### Dependency Manifest: `zim.toml`

```toml
[project]
name = "my-project"
version = "1.0.0"
zig = "0.16.0"

[dependencies]
# GitHub shorthand (recommended)
zpack = "gh/hendriknielaender/zpack@v0.3.3"
zsync = "gh/ghostkellz/zsync@main"

# Traditional formats
zhttp = { git = "https://github.com/ghostkellz/zhttp", ref = "main" }
legacy = { tarball = "https://example.com/legacy.tar.gz", hash = "sha256:abc123..." }
mylib = { path = "/path/to/mylib" }

[dev-dependencies]
test-framework = { git = "https://github.com/user/test", ref = "v1.0.0" }

[targets]
default = ["native", "wasm32-wasi"]
```

### Lockfile: `zim.lock`

```toml
# ZIM dependency lockfile
# This file is automatically generated. Do not edit manually.

# zsync = 0.7.1
# zhttp = 0.1.4
```

---

## Environment Variables

```bash
ZIM_CACHE_DIR         Override cache directory
ZIM_TOOLCHAIN_DIR     Override toolchain directory
ZIM_CA_BUNDLE         Custom CA bundle for TLS
SSL_CERT_FILE         Fallback CA bundle path
ZIM_REGISTRY_URL      Custom registry URL
ZIM_REQUIRE_SIGNATURES  Require package signatures (true/false)
```

**Example:**
```bash
export ZIM_CACHE_DIR=/tmp/zim-cache
export ZIM_REQUIRE_SIGNATURES=true
zim deps fetch
```

---

## Exit Codes

```
0   Success
1   General error
2   Invalid arguments
3   Network error
4   Hash verification failed
5   Conflict detected
```

---

## Examples

### Complete Project Setup

```bash
# Install Zig
zim install 0.16.0
zim use 0.16.0

# Initialize project
zim deps init my-awesome-project
cd my-awesome-project

# Add dependencies (GitHub shorthand recommended)
zim deps add zpack gh/hendriknielaender/zpack@v0.3.3
zim deps add zsync gh/ghostkellz/zsync@main
zim deps add zhttp gh/ghostkellz/zhttp@main

# Fetch dependencies
zim deps fetch

# Add cross-compilation target
zim target add wasm32-wasi

# Verify everything
zim verify

# Build your project
zig build
```

### Switch Between Zig Versions

```bash
# Install multiple versions
zim install 0.16.0
zim install 0.13.0

# Switch globally
zim use 0.13.0

# Or pin to project
cd my-project
zim pin 0.16.0
```

### Monorepo Workflow

```bash
# Workspace root
zim deps init workspace
cd workspace

# Add multiple packages
mkdir packages/lib1 packages/lib2
cd packages/lib1
zim deps init lib1

cd ../lib2
zim deps init lib2

# Fetch all
cd ../..
zim deps fetch
```

---

## See Also

- [API Documentation](API.md)
- [Configuration Guide](CONFIGURATION.md)
- [README](../README.md)
